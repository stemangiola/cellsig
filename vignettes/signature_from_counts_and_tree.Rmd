---
title: "Signature generation from tree and count"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Signature generation from tree and count}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r include = FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Prepare the files

In this test run, we are using data for only 2 cell types, which are - 2 NK cell subtypes- CD56bright NK and CD56dim NK cells.

```{r message=FALSE, warning=FALSE, results='hide'}

# Load the functions

source("dev/jian_R_files/cellsig_for_kamran.R", local = knitr::knit_global())


# Load the count data and tree file

count = readRDS("dev/jian_R_files/test_count_data.rds")


tree = yaml.load_file("dev/jian_R_files/test_tree.yaml") %>% 
  as.Node


# Load the bayes count file


bayes = readRDS("dev/jian_R_files/test_count_bayes.rds")  %>%

  # add sample column to bayes file

  inner_join(readRDS("dev/jian_R_files/bayes_add_sample.rds"))

```


## Produce signature using Bayesian selection

```{r message=FALSE, warning=FALSE, results='hide'}

# Signature generation function

signature_bayes = count %>%
  main(.sample = sample, .symbol = symbol, .count = count, .cell_type = cell_type,
       .is_hierarchy=FALSE,
       .tree = tree,
       .contrast_method = pairwise_contrast, .ranking_method = rank_bayes, .bayes= bayes,
       .selection_method = "silhouette", .reduction_method = "PCA", .dims=2, .discard_number = 10,
       .optimisation_method = "penalty",
       .is_complete = TRUE)

```


```{r message=FALSE, warning=FALSE}

# Signature generation function

signature_bayes

```

## Produce signature using edgeR selection

```{r message=FALSE, warning=FALSE, results='hide'}

# Signature generation function

signature_edgeR_robust = count %>%
  main(.sample = sample, .symbol = symbol, .count = count, .cell_type = cell_type,
       .is_hierarchy=FALSE,
       .tree = tree,
       .contrast_method = pairwise_contrast, .ranking_method = rank_edgR_robust_likelihood_ratio, .rank_stat="PValue",
       .selection_method = "silhouette", .reduction_method = "PCA", .dims=2, .discard_number = 10,
       .optimisation_method = "penalty",
       .is_complete = TRUE)

```

```{r message=FALSE, warning=FALSE}

signature_edgeR_robust

```