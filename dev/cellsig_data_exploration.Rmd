---
title: "cellsig_data_exploration"
author: "Jian"
date: "19/07/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message = FALSE}
# load libraries
library(devtools)
# install_github("jokergoo/ComplexHeatmap")
# devtools::install_github("stemangiola/tidyHeatmap")
# install.packages("tidyverse")
library(tidyverse)
library(tidybulk)
library(tidyHeatmap)
library(ggrepel)
library(plotly)
library(GGally)
```


```{r data}
# import data
load("/stornext/Home/data/allstaff/w/wu.j/Master Project/cellsig/dev/counts.rda")
```

```{r data inspection}
# data inspection
head(counts)

tail(counts)

str(counts)

View(counts)

levels(counts$cell_type)

levels(as.factor(counts$level))
```

```{r PCA}
# PCA at each of the five levels
tt_PCA_1 <- counts %>%
  filter(level == 1) %>%
  scale_abundance(sample, symbol, count) %>% 
  reduce_dimensions(sample, symbol, count_scaled, method = 'PCA', .dims = 4)

tt_PCA_2 <- counts %>%
  filter(level == 2) %>%
  scale_abundance(sample, symbol, count) %>% 
  reduce_dimensions(sample, symbol, count_scaled, method = 'PCA', .dims = 4)

tt_PCA_3 <- counts %>%
  filter(level == 3) %>% 
  scale_abundance(sample, symbol, count) %>% 
  reduce_dimensions(sample, symbol, count_scaled, method = 'PCA', dims = 4)

tt_PCA_4 <- counts %>%
  filter(level == 4) %>%
  scale_abundance(sample, symbol, count) %>% 
  reduce_dimensions(sample, symbol, count_scaled, method = 'PCA', .dims = 4)

tt_PCA_5 <- counts %>%
  filter(level == 5) %>%
  scale_abundance(sample, symbol, count) %>% 
  reduce_dimensions(sample, symbol, count_scaled, method = 'PCA', .dims = 4)
```
```{r}
View(tt_PCA_1)
```


```{r PCA plot}
# PCA plots at each of the 5 levels
tt_PCA_1 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = PC1, y = PC2, colour = cell_type)) +
  geom_point() +
  theme_bw()

tt_PCA_2 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = PC1, y = PC2, colour = cell_type)) +
  geom_point() +
  theme_bw()

tt_PCA_3 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = PC1, y = PC2, colour = cell_type)) +
  geom_point() +
  theme_bw()

tt_PCA_4 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = PC1, y = PC2, colour = cell_type)) +
  geom_point() +
  theme_bw()

tt_PCA_5 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = PC1, y = PC2, colour = cell_type)) +
  geom_point() +
  theme_bw()
```

```{r}
# tSNE
tt_tSNE_1 <- counts %>%
  filter(level == 1) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'tSNE',
                    perplexity = 10, pca_scale = TRUE)

tt_tSNE_2 <- counts %>%
  filter(level == 2) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'tSNE',
                    perplexity = 10, pca_scale = TRUE)

tt_tSNE_3 <- counts %>%
  filter(level == 3) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'tSNE',
                    perplexity = 10, pca_scale = TRUE)

tt_tSNE_4 <- counts %>%
  filter(level == 4) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'tSNE',
                    perplexity = 10, pca_scale = TRUE)

tt_tSNE_5 <- counts %>%
  filter(level == 5) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'tSNE',
                    perplexity = 10, pca_scale = TRUE)
```

```{r}
View(tt_tSNE_1)

View(tt_tSNE_1 %>% pivot_sample())
```

```{r}
# plot tSNE
tt_tSNE_1 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = tSNE1, y = tSNE2, colour = cell_type)) +
  geom_point() +
  theme_bw()

tt_tSNE_2 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = tSNE1, y = tSNE2, colour = cell_type)) +
  geom_point() +
  theme_bw()

tt_tSNE_3 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = tSNE1, y = tSNE2, colour = cell_type)) +
  geom_point() +
  theme_bw()

tt_tSNE_4 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = tSNE1, y = tSNE2, colour = cell_type)) +
  geom_point() +
  theme_bw()

tt_tSNE_5 %>% 
  pivot_sample() %>% 
  ggplot(aes(x = tSNE1, y = tSNE2, colour = cell_type)) +
  geom_point() +
  theme_bw()
```

```{r}
# MDS
tt_MDS_1 <- counts %>%
  filter(level == 1) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'MDS', .dims = 4)

tt_MDS_2 <- counts %>%
  filter(level == 2) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'MDS', .dims = 4)

tt_MDS_3 <- counts %>%
  filter(level == 3) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'MDS', .dims = 4)

tt_MDS_4 <- counts %>%
  filter(level == 4) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'MDS', .dims = 4)

tt_MDS_5 <- counts %>%
  filter(level == 5) %>% 
  scale_abundance(sample, symbol, count) %>%
  reduce_dimensions(sample, symbol, count_scaled, method = 'MDS', .dims = 4)
```


```{r}
View(tt_MDS_1)

View(tt_MDS_1 %>% pivot_sample())
```


```{r}
# plot MDS
tt_MDS_1 %>%  
  pivot_sample() %>% 
  ggpairs(columns = 6:9 , aes(colour = cell_type))

tt_MDS_2 %>%  
  pivot_sample() %>% 
  ggpairs(columns = 6:9 , aes(colour = cell_type))

tt_MDS_3 %>%  
  pivot_sample() %>% 
  ggpairs(columns = 6:9 , aes(colour = cell_type))
```

```{r}

tt_MDS_4 %>%  
  pivot_sample() %>% 
  ggpairs(columns = 6:9 , aes(colour = cell_type))

tt_MDS_5 %>%  
  pivot_sample() %>% 
  ggpairs(columns = 6:9 , aes(colour = cell_type))

```


```{r}
# Cluster samples
tt_MDS_1 %>% 
  cluster_elements(method = "kmeans", centers = 2, action = "get") %>% 
  ggplot(aes(x = "Dim1", y = "Dim2", colour = `cluster kmeans`)) +
  geom_point() +
  theme_bw()
```

```{r}
# cluster
tt_SNN_3 <- tt_tSNE_3 %>% 
  cluster_elements(method = "SNN")

View(tt_SNN_3)

tt_SNN_3 %>% 
  pivot_sample() %>%
  gather(source, Call, c("cluster SNN", "Call")) %>%
  distinct() %>%
  ggplot(aes(x = `tSNE1`, y = `tSNE2`, color=Call)) + 
  geom_point() + 
  facet_grid(~source) + 
  theme_bw()
```


```{r heatmap}
# heatmap
tt_PCA_1 %>%
  keep_variable(sample, symbol, count_scaled) %>%
  group_by(cell_type) %>% 
  heatmap(.row = symbol,
          .column = sample,
          .value = count_scaled)

tt_PCA_2 %>%
  keep_variable(sample, symbol, count_scaled) %>%
  group_by(cell_type) %>% 
  heatmap(.row = symbol,
          .column = sample,
          .value = count_scaled)

tt_PCA_3 %>%
  keep_variable(sample, symbol, count_scaled) %>%
  group_by(cell_type) %>% 
  heatmap(.row = symbol,
          .column = sample,
          .value = count_scaled)

tt_PCA_4 %>%
  keep_variable(sample, symbol, count_scaled) %>%
  group_by(cell_type) %>%  
  heatmap(.row = symbol,
          .column = sample,
          .value = count_scaled)

tt_PCA_5 %>%
  keep_variable(sample, symbol, count_scaled) %>%
  group_by(cell_type) %>% 
  heatmap(.row = symbol,
          .column = sample,
          .value = count_scaled)
```



```{r}
# Deconvolve cell types
tt_cybersort_1 <- counts %>% 
  tidybulk(sample, symbol, count) %>% 
  filter(level == 1) %>% 
  deconvolve_cellularity(sample, symbol, count, action = "get", cores = 2)

tt_cybersort_2 <- counts %>% 
  filter(level == 2) %>% 
  deconvolve_cellularity(sample, symbol, count, action = "get", cores = 2)

tt_cybersort_3 <- counts %>% 
  filter(level == 3) %>% 
  deconvolve_cellularity(sample, symbol, count, action = "get", cores = 2)

tt_cybersort_4 <- counts %>% 
  filter(level == 4) %>% 
  deconvolve_cellularity(sample, symbol, count, action = "get", cores = 2)

tt_cybersort_5 <- counts %>% 
  filter(level == 5) %>% 
  deconvolve_cellularity(sample, symbol, count, action = "get", cores = 2)
```

```{r}
# differential cell type abundance
counts %>% 
  test_differential_cellularity()
```


## After Monday's meeting with Stefano

```{r}
# Preprocess counts data and normalisation
counts_norm <- counts %>%
  tidybulk(sample, symbol, count) %>% 
  aggregate_duplicates() %>% 
  scale_abundance()
```


```{r}
View(counts_norm)

str(counts_norm)

str(counts_norm$count_scaled)

```


```{r}

counts_imm_epi_de <- counts_norm %>%
  mutate(count_scaled = as.integer(count_scaled)) %>% 
  filter(level == 1) %>%
  filter(cell_type %in% c("immune_cell", "epithelial")) %>%
  test_differential_abundance(sample, symbol, count_scaled, ~ cell_type) %>% 
  filter(FDR < 0.05 & abs(logFC) > 2) %>%
  nest(data = -symbol) %>%
  arrange(FDR, desc()) %>%
  slice(1:10) %>% 
  unnest()
```
```{r}
counts_imm_epi_de %>% 
  filter(FDR < 0.05 & abs(logFC) > 2) %>%
  nest(data = -symbol) %>%
  arrange(FDR, desc()) %>%
  slice(1:10) %>% 
  unnest()
```

```{r}
top_de_genes <- counts_imm_epi_de %>% 
  pull(transcript)

volcano_immi_epi <- counts_imm_epi_de %>% 
  pivot_transcript() %>% 
  mutate(siginificant = FDR < 0.05, abs(logFC) > 2) %>% 
  mutate(transcript = ifelse(transcript %in% top_de_genes, transcript, "")) %>% 
  ggplot(aes(x = log(FC), y = -log(Pvalue), label = transcript)) +
  geom_point(aes(colour = significant, alpha = significant, size = significant)) +
  geom_text_repel() +
  scale_color_manual(values=c("black", "#e11f28")) +
  scale_size_discrete(range = c(0, 2)) +
  xlim(c(-10,10)) +
  theme_bw()
```

```{r}
class(counts$cell_type)
class(counts$level)
counts %>% 
  select(cell_type, level) %>% 
  arrange(level) %>% 
  mutate(cell_type = )
```

